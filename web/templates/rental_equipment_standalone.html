<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}} - RentalCore</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .btn-orange { background-color: #ff8c00; border-color: #ff8c00; }
        .btn-orange:hover { background-color: #e67e00; border-color: #e67e00; }
        .table-hover tbody tr:hover { background-color: #f8f9fa; }
        .badge-active { background-color: #28a745; }
        .badge-inactive { background-color: #6c757d; }
        .stats-card { transition: transform 0.2s; }
        .stats-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-xl font-bold">RentalCore</h1>
                <nav class="hidden md:flex space-x-6">
                    <a href="/dashboard" class="hover:text-blue-200">Dashboard</a>
                    <div class="relative group">
                        <a href="#" class="hover:text-blue-200 flex items-center">
                            Products <i class="fas fa-chevron-down ml-1"></i>
                        </a>
                        <div class="absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden group-hover:block">
                            <a href="/products" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Own Products</a>
                            <a href="/rental-equipment" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 bg-blue-50">Rental Equipment</a>
                        </div>
                    </div>
                    <a href="/jobs" class="hover:text-blue-200">Jobs</a>
                    <a href="/customers" class="hover:text-blue-200">Customers</a>
                    <a href="/analytics" class="hover:text-blue-200">Analytics</a>
                </nav>
            </div>
            <div class="flex items-center space-x-4">
                {{if .user}}
                <span>Welcome, {{.user.Username}}</span>
                <a href="/logout" class="hover:text-blue-200">Logout</a>
                {{else}}
                <a href="/login" class="hover:text-blue-200">Login</a>
                {{end}}
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-800">Rental Equipment Management</h2>
                <p class="text-gray-600 mt-2">Manage externally rented equipment for your jobs</p>
            </div>
            <div class="flex space-x-3">
                <a href="/rental-equipment/analytics" class="btn btn-outline-primary">
                    <i class="fas fa-chart-bar mr-2"></i>Analytics
                </a>
                <button class="btn btn-orange text-white" onclick="showCreateEquipmentModal()">
                    <i class="fas fa-plus mr-2"></i>Add New Equipment
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stats-card bg-white p-6 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-100 rounded-full">
                        <i class="fas fa-boxes text-blue-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Equipment</p>
                        <p class="text-2xl font-semibold text-gray-900" id="totalEquipmentCount">{{len .rentalEquipment}}</p>
                    </div>
                </div>
            </div>

            <div class="stats-card bg-white p-6 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-3 bg-green-100 rounded-full">
                        <i class="fas fa-check-circle text-green-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Active Equipment</p>
                        <p class="text-2xl font-semibold text-gray-900" id="activeEquipmentCount">
                            {{$activeCount := 0}}
                            {{range .rentalEquipment}}{{if .IsActive}}{{$activeCount = add $activeCount 1}}{{end}}{{end}}
                            {{$activeCount}}
                        </p>
                    </div>
                </div>
            </div>

            <div class="stats-card bg-white p-6 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-3 bg-orange-100 rounded-full">
                        <i class="fas fa-building text-orange-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Suppliers</p>
                        <p class="text-2xl font-semibold text-gray-900" id="suppliersCount">
                            {{$suppliers := slice}}
                            {{range .rentalEquipment}}
                                {{$found := false}}
                                {{range $suppliers}}{{if eq . $.SupplierName}}{{$found = true}}{{end}}{{end}}
                                {{if not $found}}{{$suppliers = append $suppliers .SupplierName}}{{end}}
                            {{end}}
                            {{len $suppliers}}
                        </p>
                    </div>
                </div>
            </div>

            <div class="stats-card bg-white p-6 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-100 rounded-full">
                        <i class="fas fa-euro-sign text-purple-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Revenue</p>
                        <p class="text-2xl font-semibold text-gray-900" id="totalRevenueCount">
                            {{$totalRevenue := 0.0}}
                            {{range .rentalEquipment}}{{$totalRevenue = add $totalRevenue .TotalRevenue}}{{end}}
                            €{{printf "%.2f" $totalRevenue}}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex-1 min-w-64">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by product name, supplier, or category...">
                </div>
                <div class="flex space-x-2">
                    <select id="statusFilter" class="form-select">
                        <option value="">All Status</option>
                        <option value="active">Active Only</option>
                        <option value="inactive">Inactive Only</option>
                    </select>
                    <select id="supplierFilter" class="form-select">
                        <option value="">All Suppliers</option>
                        {{$uniqueSuppliers := slice}}
                        {{range .rentalEquipment}}
                            {{$found := false}}
                            {{range $uniqueSuppliers}}{{if eq . $.SupplierName}}{{$found = true}}{{end}}{{end}}
                            {{if not $found}}{{$uniqueSuppliers = append $uniqueSuppliers .SupplierName}}{{end}}
                        {{end}}
                        {{range $uniqueSuppliers}}
                        <option value="{{.}}">{{.}}</option>
                        {{end}}
                    </select>
                </div>
            </div>
        </div>

        <!-- Rental Equipment Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Product Name</th>
                            <th>Supplier</th>
                            <th>Category</th>
                            <th>Rental Price</th>
                            <th>Total Used</th>
                            <th>Total Revenue</th>
                            <th>Last Used</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="equipmentTableBody">
                        {{range .rentalEquipment}}
                        <tr data-equipment-id="{{.EquipmentID}}" data-status="{{if .IsActive}}active{{else}}inactive{{end}}"
                            data-supplier="{{.SupplierName}}" data-search="{{.ProductName}} {{.SupplierName}} {{.Category}}">
                            <td>
                                <div>
                                    <div class="font-weight-bold">{{.ProductName}}</div>
                                    {{if .Description}}
                                    <small class="text-muted">{{truncate .Description 50}}</small>
                                    {{end}}
                                </div>
                            </td>
                            <td>{{.SupplierName}}</td>
                            <td>
                                {{if .Category}}
                                <span class="badge bg-secondary">{{.Category}}</span>
                                {{else}}
                                <span class="text-muted">Uncategorized</span>
                                {{end}}
                            </td>
                            <td class="text-right">€{{printf "%.2f" .RentalPrice}}</td>
                            <td class="text-center">
                                {{if gt .TotalUsed 0}}
                                <span class="badge bg-info">{{.TotalUsed}} times</span>
                                {{else}}
                                <span class="text-muted">Never used</span>
                                {{end}}
                            </td>
                            <td class="text-right">€{{printf "%.2f" .TotalRevenue}}</td>
                            <td>
                                {{if .LastUsedDate}}
                                {{timeAgo .LastUsedDate}}
                                {{else}}
                                <span class="text-muted">Never</span>
                                {{end}}
                            </td>
                            <td>
                                {{if .IsActive}}
                                <span class="badge badge-active">Active</span>
                                {{else}}
                                <span class="badge badge-inactive">Inactive</span>
                                {{end}}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editEquipment({{.EquipmentID}})" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteEquipment({{.EquipmentID}})" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {{else}}
                        <tr>
                            <td colspan="9" class="text-center text-muted py-5">
                                <i class="fas fa-box-open fa-3x mb-3 text-muted"></i>
                                <p>No rental equipment found. <a href="#" onclick="showCreateEquipmentModal()" class="text-decoration-none">Add your first equipment</a></p>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Create/Edit Equipment Modal -->
    <div class="modal fade" id="equipmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="equipmentModalTitle">Add New Rental Equipment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="equipmentForm">
                        <input type="hidden" id="equipmentId" name="equipmentId">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productName" class="form-label">Product Name *</label>
                                    <input type="text" class="form-control" id="productName" name="productName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="supplierName" class="form-label">Supplier Name *</label>
                                    <input type="text" class="form-control" id="supplierName" name="supplierName" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="rentalPrice" class="form-label">Rental Price (per day) *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">€</span>
                                        <input type="number" class="form-control" id="rentalPrice" name="rentalPrice" step="0.01" min="0" required>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="category" class="form-label">Category</label>
                                    <input type="text" class="form-control" id="category" name="category" list="categoryList">
                                    <datalist id="categoryList">
                                        <option value="Audio">
                                        <option value="Video">
                                        <option value="Lighting">
                                        <option value="Stage Equipment">
                                        <option value="Transportation">
                                        <option value="Other">
                                    </datalist>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isActive" name="isActive" checked>
                                <label class="form-check-label" for="isActive">
                                    Active (available for rental)
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-orange text-white" onclick="saveEquipment()">
                        <i class="fas fa-save mr-1"></i>Save Equipment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentEquipmentId = null;

        // Search and filter functionality
        document.getElementById('searchInput').addEventListener('input', filterTable);
        document.getElementById('statusFilter').addEventListener('change', filterTable);
        document.getElementById('supplierFilter').addEventListener('change', filterTable);

        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const supplierFilter = document.getElementById('supplierFilter').value;

            const rows = document.querySelectorAll('#equipmentTableBody tr[data-equipment-id]');

            rows.forEach(row => {
                const searchText = row.getAttribute('data-search').toLowerCase();
                const status = row.getAttribute('data-status');
                const supplier = row.getAttribute('data-supplier');

                const matchesSearch = searchText.includes(searchTerm);
                const matchesStatus = !statusFilter || status === statusFilter;
                const matchesSupplier = !supplierFilter || supplier === supplierFilter;

                row.style.display = matchesSearch && matchesStatus && matchesSupplier ? '' : 'none';
            });
        }

        function showCreateEquipmentModal() {
            currentEquipmentId = null;
            document.getElementById('equipmentModalTitle').textContent = 'Add New Rental Equipment';
            document.getElementById('equipmentForm').reset();
            document.getElementById('isActive').checked = true;
            new bootstrap.Modal(document.getElementById('equipmentModal')).show();
        }

        function editEquipment(equipmentId) {
            currentEquipmentId = equipmentId;
            document.getElementById('equipmentModalTitle').textContent = 'Edit Rental Equipment';

            // Find the row with equipment data
            const row = document.querySelector(`tr[data-equipment-id="${equipmentId}"]`);
            if (!row) return;

            // This would typically fetch full details via API, for now use basic data
            // In a real implementation, make an API call to get full equipment details
            showMessage('Feature will load equipment details from API', 'info');
            new bootstrap.Modal(document.getElementById('equipmentModal')).show();
        }

        function saveEquipment() {
            const form = document.getElementById('equipmentForm');
            const formData = new FormData(form);

            const data = {
                productName: formData.get('productName'),
                supplierName: formData.get('supplierName'),
                rentalPrice: parseFloat(formData.get('rentalPrice')),
                category: formData.get('category'),
                description: formData.get('description'),
                notes: formData.get('notes'),
                isActive: document.getElementById('isActive').checked
            };

            const url = currentEquipmentId ?
                `/api/rental-equipment/${currentEquipmentId}` :
                '/api/rental-equipment';
            const method = currentEquipmentId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showMessage(data.error, 'error');
                } else {
                    showMessage(data.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('equipmentModal')).hide();
                    setTimeout(() => location.reload(), 1500);
                }
            })
            .catch(error => {
                showMessage('Error saving equipment: ' + error.message, 'error');
            });
        }

        function deleteEquipment(equipmentId) {
            if (!confirm('Are you sure you want to delete this rental equipment? This action cannot be undone.')) {
                return;
            }

            fetch(`/api/rental-equipment/${equipmentId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showMessage(data.error, 'error');
                } else {
                    showMessage(data.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                }
            })
            .catch(error => {
                showMessage('Error deleting equipment: ' + error.message, 'error');
            });
        }

        function showMessage(message, type) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }
    </script>
</body>
</html>